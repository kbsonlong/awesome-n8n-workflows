{
  "name": "2. N8N+Nanoè¡¨å•ä¿®å›¾å·¥ä½œæµ",
  "nodes": [
    {
      "parameters": {
        "formTitle": "AIå›¾åƒåˆ›ä½œåŠ©æ‰‹ - Gemini Nano",
        "formFields": {
          "values": [
            {
              "fieldLabel": "æç¤ºè¯",
              "fieldType": "textarea",
              "requiredField": true
            },
            {
              "fieldLabel": "å‚è€ƒå›¾",
              "fieldType": "file",
              "acceptFileTypes": ".jpg,.png,.jpeg"
            }
          ]
        },
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.2,
      "position": [
        -1792,
        -64
      ],
      "id": "bc71bde8-6b7b-4d45-80a5-609c5dc34af5",
      "name": "On form submission",
      "webhookId": "form-webhook-id"
    },
    {
      "parameters": {
        "jsCode": "// CodeèŠ‚ç‚¹ - ç»„è£…payloadå¹¶åˆå§‹åŒ–é‡è¯•è®¡æ•°\nconst inputData = $input.all();\nconst prompt = $input.first().json[\"æç¤ºè¯\"];\n\n// æ”¶é›†æ‰€æœ‰å›¾ç‰‡\nlet allUploadedImages = [];\n\nfor (const item of inputData) {\n  if (item.binary) {\n    for (const [fieldName, binaryData] of Object.entries(item.binary)) {\n      if (binaryData.mimeType && binaryData.mimeType.startsWith('image/')) {\n        allUploadedImages.push({\n          fieldName: fieldName,\n          fileName: binaryData.fileName,\n          data: binaryData\n        });\n      }\n    }\n  }\n}\n\n// æ„å»ºcontentæ•°ç»„\nconst content = [];\n\nif (prompt && prompt.trim()) {\n  content.push({\n    type: \"text\",\n    text: prompt.trim()\n  });\n}\n\n// å¤„ç†å›¾ç‰‡\nif (allUploadedImages.length > 0) {\n  for (let i = 0; i < allUploadedImages.length; i++) {\n    const imageItem = allUploadedImages[i];\n    const image = imageItem.data;\n    \n    if (image && image.data && image.mimeType) {\n      const base64Data = Buffer.isBuffer(image.data) ? \n        image.data.toString('base64') : \n        image.data;\n      \n      const imageUrl = `data:${image.mimeType};base64,${base64Data}`;\n      \n      content.push({\n        type: \"image_url\",\n        image_url: {\n          url: imageUrl\n        }\n      });\n    }\n  }\n}\n\n// æ„å»ºpayload\nconst payload = {\n  model: \"google/gemini-2.5-flash-image-preview:free\",\n  messages: [\n    {\n      role: \"user\",\n      content: content\n    }\n  ]\n};\n\nif (payload.messages[0].content.length === 0) {\n  payload.messages[0].content.push({\n    type: \"text\",\n    text: \"è¯·åˆ†æè¿™ä¸ªå†…å®¹\"\n  });\n}\n\n// è¿”å›payloadå’Œé‡è¯•è®¡æ•°\nreturn [{\n  json: {\n    apiPayload: payload,\n    retryCount: 0,\n    maxRetries: 5,\n    originalFormData: $input.first().json\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        -64
      ],
      "id": "d3e25f23-a157-4a42-a21c-92cf3a3b8f74",
      "name": "Code"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openRouterApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.apiPayload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1312,
        -64
      ],
      "id": "e4baa01c-60f5-4cdc-a0ff-784b5f6ca9b9",
      "name": "HTTP Request",
      "credentials": {
        "openRouterApi": {
          "id": "PniCfeNtv6tmsVxZ",
          "name": "OpenRouter account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "merge-api-response",
              "name": "apiResponse",
              "value": "={{ $json }}",
              "type": "object"
            },
            {
              "id": "keep-max-retries",
              "name": "maxRetries",
              "value": "={{ $('Code').item.json.maxRetries }}",
              "type": "number"
            },
            {
              "id": "keep-api-payload",
              "name": "apiPayload",
              "value": "={{ $('Code').item.json.apiPayload }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1088,
        -112
      ],
      "id": "4744a41c-c765-4fd2-b1d0-6f9611a5a29f",
      "name": "Merge Response Data"
    },
    {
      "parameters": {
        "errorMessage": "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -1088,
        48
      ],
      "id": "d079aa9d-4448-458a-b035-5551c315985a",
      "name": "Network Error"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "content-filter-check",
              "leftValue": "={{ $json.apiResponse.choices[0].finish_reason === \"content_filter\" }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -896,
        -144
      ],
      "id": "7b1cccaa-4275-4575-a7ac-64c967fed27d",
      "name": "Content Filter Check"
    },
    {
      "parameters": {
        "operation": "completion",
        "completionTitle": "æŠ±æ­‰ï¼Œæ‚¨çš„å†…å®¹åŒ…å«ä¸å½“ä¿¡æ¯",
        "completionMessage": "è¯·é‡æ–°ä¸Šä¼ å‚è€ƒå›¾æˆ–è€…ä¿®æ”¹æç¤ºè¯åé‡è¯•",
        "options": {}
      },
      "type": "n8n-nodes-base.form",
      "typeVersion": 1,
      "position": [
        -688,
        -272
      ],
      "id": "5ea0fc21-f5c8-49b4-ac81-beedb9e08a9a",
      "name": "Prohibited Content End",
      "webhookId": "prohibited-webhook-id"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "image-exists-check",
              "leftValue": "={{ $json.apiResponse.choices[0].message.images }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -688,
        -64
      ],
      "id": "3c0905d2-9b13-426e-86ff-a93df8c8678f",
      "name": "Image Check"
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -496,
        64
      ],
      "id": "5bbca17b-a1ab-40c0-858d-8ddf5e2568d7",
      "name": "Wait",
      "webhookId": "wait-webhook-id"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "extract-base64",
              "name": "base",
              "value": "={{ $json.apiResponse.choices[0].message.images[0].image_url.url.split(\",\")[1] }}",
              "type": "string"
            },
            {
              "id": "extract-mime",
              "name": "mime",
              "value": "={{ $json.apiResponse.choices[0].message.images[0].image_url.url.match(/^data:([^;]+)/)[1] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -480,
        -176
      ],
      "id": "c7c9755a-d7bc-42b8-9615-8f6aad4b81fc",
      "name": "Extract Image Data"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "base",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -288,
        -176
      ],
      "id": "b0a25a58-b98a-41cb-b9d6-b08612618780",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "operation": "completion",
        "respondWith": "returnBinary",
        "completionTitle": "ğŸ‰ æ‚¨çš„å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆï¼",
        "options": {}
      },
      "type": "n8n-nodes-base.form",
      "typeVersion": 1,
      "position": [
        -128,
        -176
      ],
      "id": "c4d9468b-d81f-4b33-9905-c0e584d4f573",
      "name": "Success Form",
      "webhookId": "success-webhook-id"
    },
    {
      "parameters": {
        "content": "#### é…ç½® OpenRouter å‡­è¯ ğŸ‘‡",
        "height": 80,
        "width": 214,
        "color": 3
      },
      "id": "88675f0e-eec9-45ac-95a1-0b02460e3e91",
      "name": "Sticky Note12",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1376,
        -112
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ğŸ¨ N8N+Nanoè¡¨å•ä¿®å›¾å·¥ä½œæµ\n#### [AIè‡ªåŠ¨åŒ–åœºæ™¯å®æˆ˜è¯¾ï¼šè®©é‡å¤å·¥ä½œæˆä¸ºè¿‡å»å¼](https://rvfdqgohv5q.feishu.cn/wiki/DkU6we3HGiKgNzkYRHLcOdBMncd)\n\n> N8N_DEFAULT_BINARY_DATA_MODE ç›®å‰åªæ”¯æŒ default\n\nğŸ“‹ åŸºæœ¬ä¿¡æ¯\nâ€¢ å·¥ä½œæµåç§°: Nano-Form-Image-Editor\nâ€¢ ç‰ˆæœ¬: v1.0.0\nâ€¢ æŠ€æœ¯æ ˆ: N8N + OpenRouter + Form Trigger\nâ€¢ æ”¯æŒæ¨¡å¼: æ–‡ç”Ÿå›¾ + å›¾ç‰‡ä¿®å›¾\n\nğŸ¯ åŠŸèƒ½æ¦‚è¿°\nåŸºäºè¡¨å•çš„AIå›¾åƒåˆ›ä½œåŠ©æ‰‹ï¼Œæ”¯æŒçº¯æ–‡ç”Ÿå›¾å’Œä¸Šä¼ å›¾ç‰‡ä¿®å›¾ä¸¤ç§æ¨¡å¼ã€‚\nç”¨æˆ·é€šè¿‡è¡¨å•ç•Œé¢æäº¤æç¤ºè¯å’Œå¯é€‰å‚è€ƒå›¾ï¼Œç³»ç»Ÿæ™ºèƒ½è¯†åˆ«éœ€æ±‚å¹¶è°ƒç”¨ Nano æ¨¡å‹ç”Ÿæˆé«˜è´¨é‡å›¾ç‰‡ã€‚\n\nâš™ï¸ é…ç½®è¯´æ˜\n1. Form Triggeré…ç½®\n   â—‹ è¡¨å•æ ‡é¢˜: AIå›¾åƒåˆ›ä½œåŠ©æ‰‹ - Gemini Nano\n   â—‹ æç¤ºè¯å­—æ®µ: å¿…å¡«æ–‡æœ¬åŸŸï¼Œæ”¯æŒè¯¦ç»†æè¿°\n   â—‹ å‚è€ƒå›¾å­—æ®µ: å¯é€‰æ–‡ä»¶ä¸Šä¼ ï¼Œæ”¯æŒ.jpg/.png/.jpeg\n\n2. CodeèŠ‚ç‚¹å…³é”®é€»è¾‘\n   â—‹ æ™ºèƒ½è¯†åˆ«ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶\n   â—‹ è‡ªåŠ¨ç»„è£…å¤šæ¨¡æ€APIè¯·æ±‚ä½“\n   â—‹ å¤„ç†æ–‡æœ¬+å›¾ç‰‡çš„å¤åˆè¾“å…¥\n\n\nğŸ’¡ ä½¿ç”¨åœºæ™¯\nâ€¢ çº¯æ–‡ç”Ÿå›¾: åªå¡«å†™æç¤ºè¯ï¼Œå¿«é€Ÿç”Ÿæˆåˆ›æ„å›¾ç‰‡\nâ€¢ AIä¿®å›¾: ä¸Šä¼ å‚è€ƒå›¾+æè¿°éœ€æ±‚ï¼Œæ™ºèƒ½å›¾ç‰‡ç¼–è¾‘\nâ€¢ é£æ ¼è½¬æ¢: å°†ç°æœ‰å›¾ç‰‡è½¬æ¢ä¸ºä¸åŒè‰ºæœ¯é£æ ¼\nâ€¢ è§’è‰²åˆ›ä½œ: æ ¹æ®æè¿°ç”Ÿæˆè§’è‰²å½¢è±¡æˆ–æ‰‹åŠæ•ˆæœ",
        "height": 720,
        "width": 2208,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2160,
        -432
      ],
      "typeVersion": 1,
      "id": "ba9780ad-c771-4f94-8775-6db10f33186d",
      "name": "Sticky Note"
    }
  ],
  "pinData": {},
  "connections": {
    "On form submission": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Merge Response Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Network Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Response Data": {
      "main": [
        [
          {
            "node": "Content Filter Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Content Filter Check": {
      "main": [
        [
          {
            "node": "Prohibited Content End",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Image Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Image Check": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Image Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Image Data": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Success Form",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "bac30edf-c897-424e-bf07-546c396cd1b1",
  "meta": {
    "instanceId": "a152539bc323133bde80781a1dc51fefe2ad2e9f6579ca96b98f3bb66ae5bb00"
  },
  "id": "fUu3tpY5DXzTSM0M",
  "tags": []
}